<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.53" />

<title>Harry Ahlas - Multi Condition Data Retrieval</title>
<meta property="og:title" content="Harry Ahlas - Multi Condition Data Retrieval">

<link href='http://earlydemise.com/blog/public/css/github.min.css' rel='stylesheet' type='text/css' />
<link rel="stylesheet" href="http://earlydemise.com/blog/public/css/fonts.css" media="all">
<link rel="stylesheet" href="http://earlydemise.com/blog/public/css/main.css" media="all">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="http://earlydemise.com/blog/public/index.html" class="nav-logo">
    <img src="http://earlydemise.com/blog/public/images/harryconf.jpg"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
	<li><a href="http://earlydemise.com/blog/public/about/index.html">About</a></li>
    <li><a href="https://www.linkedin.com/in/harry-ahlas-b471b7137">LinkedIn</a></li>
    <li><a href="https://twitter.com/harry_ahlas">Twitter</a></li>
  </ul>
</nav>
      </header>

<main class="content" role="main">
  <article class="article">
    <span class="article-duration">2 min read</span>
    <h1 class="article-title">Multi Condition Data Retrieval with R and SQL</h1>

    <span class="article-date">2019/03/09</span>
One example I run into often in Human Resources analytics is when a client comes to me with a couple columns of data on an Excel file and asks to join my data to his/hers.  Usually the client's data has an employee number and a date.  

<p>Often standard business intelligence data tools fail to meet the need and more flexible coding tools, such as R and SQL, come in handy.
<p>Our Human Resources systems are built for simple queries with one condition that needs to be met. For example, a client may come to me with a list of employee numbers and ask to join some HR data. The BI tools work great for that. However, when an additional condition needs to be met, such as a list of dates, the BI tool often fails.  
<p>image with excel and 1 column: easy
<p>image with excel and 2 columns: hard
<p>If the client needs 5 rows of data this is not a big issue and you can spend a few minutes creating 10 filters in the BI interface.  <p>But what if the client wants 100 rows? Or 1,000 or 100,000?  At that point I have another problem: my Oracle database limits me to 1,000 items per filter. Furthermore, these large queries tend to take a long time and can potentially time out. Yuck!
<p></p> areturn to SQL.
<p>And what do you do when the SQL has limitations</p>
Our systems do not allow us to create 
Here is a solution 
<p>This post will </p>
<ul class="task-list">
	<li><label>Import client spreadsheet into R</label></li>
	<li><label>Connect R to a sample MySQL database</label></li>
	<li><label>Create an SQL query  with multiple placeholders</label></li>
	<li><label>Iterate the SQL query through the client data</label></li>
	<li><label>Export the updated file for the client</label></li>  
</ul>


What do you do when a client comes to you with a spreadsheet and asks you to supply
	
	<h3 class="article-subtitle">Client Data</h3>
<p>We'll start with Excel to see what the client is looking for. <a href="xxx">Here is a link</a> to the file and here is a screengrab:</p>
<img src="client_input.gif">
<p>The client has privided us with a list of employee numbers (employee names are typically excluded from sensitive data) and dates and asked us to populate the <code>`Job Name`</code> field. So the client wants to know what job title - if any - the employee had on that date.
<p>Let's move to R, load our libraries, and import our data using readxl. <b>Note: need to change excel to github raw</b>

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">library(RMariaDB)
library(tidyverse)
library(openxlsx)
library(readxl)

input_data &lt;- read_xlsx("data/Johnson litigation research.xlsx")</pre>
</div>

<p>We will remove the <code>`Job Name`</code> field since it will be replaced.  Additionally, let's update the date field to a date format to help with joins later.

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">input_data &lt;- input_data %>% 
  select(-`Job Name`) %>% 
  mutate(`Date of incident or notification` = as.Date(`Date of incident or notification`))</pre>
</div>

	<h3 class="article-subtitle">The HR Sample Database and Connecting to R</h3>
<p>I have created a sample HR MySQL database, which you can read about and learn how to install on your machine, <a href="">here</a>.   You should be able to install MySQL and this database start to finish in about an hour.  MySQL is free as is the HR Sample database. 

<p>Use the <code>RMariaDB</code> package to connect to HRSAMPLE and take a look at the tables available.

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">HRSAMPLE &lt;- dbConnect(MariaDB(), 
                      user='newuser', 
                      password='newuser', 
                      dbname='hrsample', 
                      host='localhost')
					  
dbListTables(HRSAMPLE)
[1] "deskhistory"       "deskjob"          
[3] "employeeinfo"      "hierarchy"        
[5] "performancereview" "salaryhistory"</pre>
</div>

<p>To get the job information we will need to query two of these tables. The <code>deskhistory</code> table has a history of employee <code>desk_id</code> (positions) in the company. The <code>deskjob</code> table shows what jobs belong to each <code>desk_id</code>. 

<h3 class="article-subtitle">Create an SQL Suery with Multiple Placeholders</h3>

<p>Below is a sample SQL script called mcdr_test.sql.  This script retrieves employee number 43349's job on December 5, 2003.  

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">SELECT
 '2003-12-05' AS "Date of incident or notification",
 DH.employee_num,
 DH.desk_id,
 DJ.job_name
 FROM 
	`hrsample`.`deskhistory` DH, 
    `hrsample`.`deskjob` DJ  
 WHERE 
 DJ.desk_id = DH.desk_id
 AND DH.employee_num = 43349 
 AND DH.desk_id_start_date &lt;= DATE('2003-12-05') 
 AND DH.desk_id_end_date &lt;= DATE('2003-12-05') ;</pre>
</div>	

<p>The script has been saved online <b>(needs to be saved)</b>and you can run it using the code below in R. You can see this employee was a Consultant on 12/5/2003.

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">test_sql &lt;- read_file("scripts/mcdr_test.sql")
test_df &lt;- dbGetQuery(HRSAMPLE, test_sql)
test_df

  Date of incident or notification employee_num desk_id   job_name
1                       2003-12-05        43349     228 Consultant</pre>
</div>		
	
<p>Now that we have script that can pull one employee's data, we will add placeholders to the script for the two conditions that can change - <code>employee_num</code> and <code>Date of incident or notification</code>.  Let's replace <code>employee_num</code> with <code>%EMP_ID%</code>  and for <code>Date of incident or notification</code> let's use <code>%DATE_ID%</code>.  The new code with the placeholders looks like this:

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">SELECT
 DATE('%DATE_ID%') AS "Date of incident or notification",
 DH.employee_num,
 DH.desk_id,
 DJ.job_name
 FROM 
	`hrsample`.`deskhistory` DH, 
    `hrsample`.`deskjob` DJ  
 WHERE 
 DJ.desk_id = DH.desk_id
 AND DH.employee_num = %EMP_ID% 
 AND DH.desk_id_start_date &lt;= DATE('%DATE_ID%') 
 AND DH.desk_id_end_date >= DATE('%DATE_ID%') ;</pre>
</div>	

<p>So now we have a script we can iterate through with different variables.  Note the % signs in the placeholders are not required.  
<p>Let's do another test to make sure the script with the placeholders works. We'll use base R's <code>gsub</code> function to fill the placeholders with the client's data.

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content"># Import sql script with placeholders
mvdr_sql_placeholder &lt;- read_file("scripts/mcdr.sql")

# Replace placeholders with sample employee_num and date
mvdr_sql &lt;- mvdr_sql_placeholder %>% 
  gsub(pattern = '%EMP_ID%',
       replacement = input_data$`Employee Number`[2],
       x = .) %>% 
  gsub(pattern = '%DATE_ID%',
       replacement = input_data$`Date of incident or notification`[2],
       x = .)

# Retrieve data
df_one_row &lt;- dbGetQuery(HRSAMPLE, mvdr_sql)

df_one_row
  Date of incident or notification employee_num desk_id        job_name
1                       2007-05-20        15011      88 Regional Leader</pre>
</div>	

<p>The code is working and is ready to be run through the client data.	

	<h3 class="article-subtitle">Iterate the SQL query through the client data</h3>
	
<p>To retrieve the data, we will create an empty data frame called <code>df</code>. As we cycle through the client data, we'll append our results to <code>df</code>.  

<p>A few notes you might be wondering about.  I often add a disconnect/reconnect snippet in order to prevent the database from timing out.  You won't face that issue here since it is a local machine.  Also, if you need to improve performance, you could paginate and do something like 1,000 rows at a time.  For my needs, the one at a time approach works and is easier to debug.
	
	
	
	
<p>I wanted to speed up the process of uploading this website to the hosting server, as opposed to doing a lot of drag and drop to the ftp client.  It turned out to be super easy using R. If you need to do the same, the following code can help get you there. It will replace old files and directories and create new ones as needed.
<p>Simply set your working directory to the root directory with the folders/files you want to upload.  Then replace your username, password, server name, and the root directory you want to update here: <code>sftp://User:Password@FTPServer/your_directory_name/</code> 

<div class="scrollbox" tabindex="0">
 	<pre class="scrollbox-content">library(RCurl)

files_for_upload &lt;- list.files(getwd(), 
                             full.names=F,
                             recursive = TRUE)

for (file_for_upload in files_for_upload) {
  print(file_for_upload)
  ftpUpload(file_for_upload, 
            ftpUpload(file_for_upload, paste0("sftp://User:Password@FTPServer/your_directory_name/",
				file_for_upload),
            .opts = list(ftp.create.missing.dirs=TRUE)
  )
}  </pre>
</div>



    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <!--<li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>-->
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="http://earlydemise.com/blog/public/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    


<!--
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
-->

    
  </body>
</html>

