Efficient filesearching with R


This script searches a directory or drive for specific text in specific filetypes.  I use it often and thought it is worth sharing.  Here is a link to <a href="https://github.com/harryahlas/file_search/blob/master/file_search.R">the code</a> and to the <a href="https://github.com/harryahlas/file_search">github repository</a>.

When do you use it? On occasion, there are times where you need to look through old work for something.  For example, maybe there is a change to field in a database and you need to understand how it impacts your prior work.  You may want to know which old scripts have that field name.  One option might be to search every file in your drive for that filename. However, you run into two problems when you search through all files: 
* searching through every file in a drive could take a very long time to run (days).  
* the result set you return may be larger than what you want.  You may be only interested in .sql scripts but this could be returning MS Word files.

Using this script, you can speed up the search and have a better set of results.

For this exercise, please open RStudio > File > New Project... > Version Control > Git.  Under <em>Repository URL</em> paste https://github.com/harryahlas/file_search.git then click <em>Create Project</em>. Then under the <em>Files</em> tab click <em>file_search.R</em>.



In this example, let's say we are interested in knowing what SQL and README files in the <em>sql-data-warehouse-samples-master</em> directory contain the text "security" or "exec". We only need to search through files ending in either <em>.sql</em> or <em>.md</em>.

Let's walk through the code.  

I am a big fan of the <code>tidyverse</code> workflow; we'll start by loading this package.
library(tidyverse)

In this example, we'll search the <em>sql-data-warehouse-samples-master</em> folder.  Note: these files are sourced from https://github.com/Microsoft/sql-data-warehouse-samples.

directory_to_search <- "sql-data-warehouse-samples-master"

Of course you can switch this to any directory you choose.

Next we'll specify the types of files we want to search.  We are only interested in SQL and README files, so we will look for files that end in either <em>.sql</em> or <em>.md</em>

extension_types <- c(".sql", ".md")

Now we will specify the terms that we want to search for within each SQL or README file.
search_terms <- c("security", "exec")

Later we will use the <code>grepl</code> function to search through files. This next section of code will format our search terms to fit within <code>grepl</code>
extension_types_re <- paste0(extension_types, "$", collapse = "|") 
search_terms_re <- paste0(search_terms, collapse = "|")

This is the end result of the formatting:
> extension_types_re
[1] ".sql$|.md$"
> search_terms_re
[1] "security|exec"

Next, we'll get a list of all the files in the directory, including child folders.  We'll put them into a data frame and then filter for filenames ending in <em>.sql</em> or <em>.md</em>.  By searching for only certain filetypes, you could save a lot of time, especially if it is a larger repository.

<code>files_to_search <- list.files(directory_to_search, recursive = TRUE, full.names = TRUE) %>% 
  tibble(filenames = .) %>% 
  filter(grepl(extension_types_re, filenames, ignore.case = TRUE)) </code>

Let's look at <code>files_to_search</code>.
<code>files_to_search %>% head()
# A tibble: 6 x 1
  filenames                                                                                                  
  <chr>                                                                                                      
1 sql-data-warehouse-samples-master/arm-templates/sqlDwAutoScaler/SqlDwAutoScaler/ScaleSqlDw/readme.md       
2 sql-data-warehouse-samples-master/arm-templates/sqlDwAutoScaler/SqlDwAutoScaler/ScaleSqlDwByTimer/readme.md
3 sql-data-warehouse-samples-master/arm-templates/sqlDwTimerScaler/README.md                                 
4 sql-data-warehouse-samples-master/samples/adf/management-operations/Readme.md                              
5 sql-data-warehouse-samples-master/samples/adf/Readme.md                                                    
6 sql-data-warehouse-samples-master/samples/automation/RefreshReplicatedTable/README.md </code>     
  
Last, we will read in each file and look for our search terms.  We'll map the <code>read_file()</code> function to each observation of <code>files_to_search</code>.  Next is a filter that keeps any file with text that includes the search terms we are looking for.  We will also use <em>unnest()</em> to put the text into its own variable.

<code>files_identified <- files_to_search %>% 
  mutate(file_text = map(filenames, read_file)) %>% 
  filter(grepl(search_terms_re, file_text, ignore.case = TRUE)) %>% 
  unnest(file_text)</code>

And here is our output:
<code>files_identified$filenames %>% head()
[1] "sql-data-warehouse-samples-master/arm-templates/sqlDwAutoScaler/SqlDwAutoScaler/ScaleSqlDw/readme.md"       
[2] "sql-data-warehouse-samples-master/arm-templates/sqlDwAutoScaler/SqlDwAutoScaler/ScaleSqlDwByTimer/readme.md"
[3] "sql-data-warehouse-samples-master/samples/adf/management-operations/Readme.md"                              
[4] "sql-data-warehouse-samples-master/samples/adf/Readme.md"                                                    
[5] "sql-data-warehouse-samples-master/samples/scripts/deployments/GetCreateStatement_Table.sql"                 
[6] "sql-data-warehouse-samples-master/samples/scripts/monitor/concurrency/running_queued_queries_slots.sql" </code>

Let me know if you have any feedback - feel free to reach out on Twitter or GitHub. I think there is room for improvement, especially for error handling.  Thank you.

Full code:
<code>library(tidyverse)

# Identify directory to search
directory_to_search <- "sql-data-warehouse-samples-master"

# Identify filetypes/suffixes to search
extension_types <- c(".sql", ".md")

# Identify search terms
search_terms <- c("security", "exec")

# Format search terms and extensions for grepl filter
extension_types_re <- paste0(extension_types, "$", collapse = "|") 
search_terms_re <- paste0(search_terms, collapse = "|")

# View
extension_types_re
search_terms_re

# Identify files to search
files_to_search <- list.files(directory_to_search, recursive = TRUE, full.names = TRUE) %>% 
  tibble(filenames = .) %>% 
  filter(grepl(extension_types_re, filenames, ignore.case = TRUE)) 

files_to_search %>% head()

# Read files and search
files_identified <- files_to_search %>% 
  mutate(file_text = map(filenames, read_file)) %>% 
  filter(grepl(search_terms_re, file_text, ignore.case = TRUE)) %>% 
  unnest(file_text)

files_identified$filenames %>% head()</code>